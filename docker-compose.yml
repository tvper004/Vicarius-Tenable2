
services:

  appdb:
    build:
      context: ./appdb
      dockerfile: Dockerfile
    restart: always
    environment:
      # Database configuration via environment variables
      POSTGRES_DB: ${POSTGRES_DB:-vanalyzer}
      POSTGRES_USER: ${POSTGRES_USER:-vicarius_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - vicarius-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vicarius_user} -d ${POSTGRES_DB:-vanalyzer} && pg_isready -U ${POSTGRES_USER:-vicarius_user} -d metabase"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    restart: always
    volumes:
      - ./app/reports:/usr/src/app/reports
      - ./app/logs:/var/log
      - ./app/scripts:/usr/src/app/scripts
      - /etc/localtime:/etc/localtime:ro
    networks:
      - vicarius-network
    depends_on:
      appdb:
        condition: service_healthy
      metabase:
        condition: service_started
    environment:
      # Vicarius API Configuration
      VICARIUS_API_KEY: ${VICARIUS_API_KEY}
      VICARIUS_DASHBOARD_ID: ${VICARIUS_DASHBOARD_ID}
      
      # Tenable API Configuration
      TENABLE_API_KEY: ${TENABLE_API_KEY}
      TENABLE_SECRET_KEY: ${TENABLE_SECRET_KEY}
      
      # Database Configuration
      POSTGRES_DB: ${POSTGRES_DB:-vanalyzer}
      POSTGRES_USER: ${POSTGRES_USER:-vanalyzer_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: appdb
      POSTGRES_PORT: 5432
      
      # Optional Tools
      OPTIONAL_TOOLS: ${OPTIONAL_TOOLS:-}

  metabase:
    image: metabase/metabase:latest
    restart: always
    depends_on:
      appdb:
        condition: service_healthy
    hostname: metabase
    ports:
      - "3040:3000"
    volumes:
      - metabase-data:/metabase-data
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Metabase Database Configuration
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: ${POSTGRES_USER:-vicarius_user}
      MB_DB_PASS: ${POSTGRES_PASSWORD}
      MB_DB_HOST: appdb
      # Configuraci√≥n de puerto
      MB_JETTY_PORT: 3000
    networks:
      - vicarius-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres-data:
  metabase-data:

networks:
  vicarius-network:
    attachable: true
